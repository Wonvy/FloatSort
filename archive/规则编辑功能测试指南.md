# ✅ 规则编辑功能测试指南

## 🎉 新增功能

### 1. 规则编辑
- ✅ 可以编辑已创建的规则
- ✅ 修改规则名称、类型、匹配值、目标文件夹
- ✅ 保存后立即生效

### 2. 改进的设置界面
- ✅ 每个规则显示"编辑"和"删除"按钮
- ✅ 点击"编辑"打开规则表单并填充当前值
- ✅ 删除使用规则 ID（更安全）

---

## 🧪 测试步骤

### **测试 1：创建规则**

1. 点击 **"➕ 添加规则"**
2. 填写：
   - 规则名称：`图片归类`
   - 匹配类型：`文件扩展名`
   - 匹配值：`jpg, png`
   - 目标文件夹：选择一个文件夹
3. 点击 **"保存规则"**
4. **预期结果：**
   - ✅ 通知显示："规则 '图片归类' 已添加"
   - ✅ 活动日志显示："📝 规则已添加: 图片归类"

---

### **测试 2：编辑规则** ⭐ 新功能

1. 点击 **"⚙️ 设置"** 按钮
2. 在规则列表中找到 "图片归类"
3. 点击 **"编辑"** 按钮
4. **预期结果：**
   - ✅ 设置窗口关闭
   - ✅ 规则表单窗口打开
   - ✅ 标题显示："✏️ 编辑规则"
   - ✅ 表单已填充当前规则的值：
     - 规则名称：`图片归类`
     - 匹配类型：`文件扩展名`
     - 匹配值：`jpg, png`
     - 目标文件夹：(原路径)

5. 修改规则：
   - 规则名称改为：`所有图片`
   - 匹配值改为：`jpg, png, gif, bmp`
   
6. 点击 **"保存规则"**

7. **预期结果：**
   - ✅ 通知显示："规则 '所有图片' 已更新"
   - ✅ 活动日志显示："✏️ 规则已更新: 所有图片"
   - ✅ 表单关闭

8. 再次打开设置，验证：
   - ✅ 规则名称已变为 "所有图片"
   - ✅ 扩展名显示：`jpg, png, gif, bmp`

---

### **测试 3：取消编辑**

1. 打开设置，点击某个规则的 **"编辑"**
2. 修改一些内容
3. 点击 **"取消"** 或 **"✕"** 关闭按钮
4. **预期结果：**
   - ✅ 表单关闭
   - ✅ 规则未被修改

---

### **测试 4：删除规则** ✅ 已改进

1. 打开设置
2. 点击某个规则的 **"删除"** 按钮
3. 确认删除
4. **预期结果：**
   - ✅ 通知显示："规则 'xxx' 已删除"
   - ✅ 规则从列表中移除
   - ✅ 规则计数减少

---

### **测试 5：编辑后使用规则**

1. 创建规则：
   - 名称：`文档整理`
   - 类型：`文件扩展名`
   - 值：`doc, docx`
   - 目标：`D:\TestDocs`

2. 使用手动拖拽测试：
   - 拖拽一个 `.docx` 文件到应用
   - **预期：** 文件移动到 `D:\TestDocs`

3. 编辑规则：
   - 添加扩展名：`doc, docx, pdf, txt`
   - 修改目标：`D:\AllDocuments`

4. 再次拖拽测试：
   - 拖拽一个 `.pdf` 文件
   - **预期：** 文件移动到 `D:\AllDocuments`（新目标）

---

## 🎯 功能特性

### **新增功能**

1. **智能表单填充**
   - 自动识别规则类型
   - 自动填充所有字段
   - 支持所有规则类型（扩展名、大小、名称包含）

2. **双模式支持**
   - 新增模式：标题 "📝 创建规则"
   - 编辑模式：标题 "✏️ 编辑规则"
   - 使用相同表单，逻辑自动切换

3. **安全删除**
   - 使用规则 ID 而不是数组索引
   - 避免删除错误规则

---

## 📊 后端 API

### 新增命令

#### `update_rule`
```javascript
await invoke('update_rule', {
    ruleId: 'rule_xxx',
    rule: {
        id: 'rule_xxx',
        name: '新规则名',
        enabled: true,
        conditions: [...],
        action: {...},
        priority: 0
    }
});
```

#### `remove_rule` (已更新)
```javascript
// 之前：使用索引
await invoke('remove_rule', { index: 0 });

// 现在：使用 ID
await invoke('remove_rule', { ruleId: 'rule_xxx' });
```

---

## 🐛 已知限制

### 当前版本限制

1. **不支持批量编辑**
   - 只能逐个编辑规则

2. **不支持复制规则**
   - 无法快速创建相似规则

3. **不支持规则排序**
   - 规则优先级固定为 0

### 未来改进方向

1. ✨ 规则拖拽排序
2. ✨ 规则复制功能
3. ✨ 规则导入/导出
4. ✨ 规则模板
5. ✨ 批量操作

---

## 📝 技术实现细节

### 前端改动

1. **新增状态变量**
   ```javascript
   let editingRuleId = null; // 当前编辑的规则 ID
   ```

2. **新增函数**
   ```javascript
   openRuleModal(rule) // 打开规则表单（支持编辑）
   ```

3. **修改函数**
   ```javascript
   saveRule()        // 支持新增/编辑双模式
   showSettings()    // 添加"编辑"按钮
   closeModal()      // 清理编辑状态
   ```

### 后端改动

1. **修改命令**
   ```rust
   fn remove_rule(rule_id: String, ...) // 使用 ID 而不是索引
   fn update_rule(rule_id: String, rule: Rule, ...) // 使用 ID
   ```

2. **安全性提升**
   - 通过 ID 查找规则
   - 验证规则存在性
   - 返回友好错误消息

---

## 🎉 下一步可以做什么

### Option A: 停在这里 ✅
**当前功能已满足基本需求：**
- ✅ 创建规则
- ✅ 编辑规则
- ✅ 删除规则
- ✅ 文件监控
- ✅ 手动整理

**适合：** 快速使用，功能够用

---

### Option B: 继续完整重构 🚀
**参考：** `V2架构设计.md`

**内容：**
1. 文件夹独立配置
2. 文件夹独立监控开关
3. Tab 式 UI
4. 更多高级功能

**工作量：** 10-12 小时

**适合：** 追求完美体验

---

### Option C: 小步优化 ⚡
**快速改进（1-2 小时）：**
- [ ] 规则优先级调整
- [ ] 规则复制功能
- [ ] 规则启用/禁用开关
- [ ] 更多规则类型

**适合：** 渐进式改进

---

## 💬 反馈

**测试完成后请告诉我：**

1. ✅ 规则编辑功能是否正常工作？
2. ✅ 是否满足您的需求？
3. ❓ 是否需要继续完整重构？
4. ❓ 还需要哪些功能？

**我会根据您的反馈决定下一步！** 🚀

