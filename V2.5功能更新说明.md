# FloatSort V2.5 功能更新说明

📅 更新日期：2025-10-28  
✨ 版本：V2.5.0

---

## 🎉 **新功能概览**

### 1. **Mini窗口自动折叠隐藏** 🎨
- Mini窗口移动到屏幕边缘时自动折叠
- 鼠标移到边缘时自动展开
- 类似macOS Dock的智能隐藏体验

### 2. **无边框窗口 + 自定义标题栏** 🪟
- 删除Windows系统标题栏
- 极简黑色自定义标题栏
- 拖动、最小化、关闭功能完整

### 3. **批量确认阈值可配置** ⚙️
- 默认改为1个文件就弹窗确认
- 用户可在配置文件中自定义
- 更精确的文件整理控制

---

## 🎨 **Mini窗口自动折叠功能**

### **工作原理**

```
┌─────────────────────────────────────────┐
│  ◄ 边缘50px  │     屏幕中央      │  边缘50px ►  │
│                                         │
│    自动折叠   │   正常显示    │   自动折叠     │
└─────────────────────────────────────────┘
```

### **折叠行为**

#### **自动折叠条件**
- Mini窗口距离屏幕边缘 **≤ 50像素**
- 鼠标离开Mini窗口区域

#### **折叠效果**

| 边缘位置 | 折叠动画 | 可见部分 |
|---------|---------|---------|
| **左边缘** | 向左滑动90% | 只显示右侧10% |
| **右边缘** | 向右滑动90% | 只显示左侧10% |
| **上边缘** | 向上滑动90% | 只显示底部10% |
| **下边缘** | 向下滑动90% | 只显示顶部10% |

#### **自动展开条件**
- 鼠标移到折叠的窗口区域

### **使用场景**

#### **场景1：固定在屏幕左侧**
```
1. 进入Mini模式
2. 拖动窗口到屏幕左边缘
3. 鼠标离开 → 窗口自动折叠，只露出一条边
4. 鼠标移回边缘 → 窗口自动展开
5. 拖拽文件整理
```

#### **场景2：固定在屏幕底部**
```
1. Mini模式窗口拖到屏幕底部
2. 鼠标离开 → 自动折叠到底部
3. 需要时鼠标移到底部边缘 → 展开
4. 点击展开的窗口 → 返回完整界面
```

### **交互逻辑**

```javascript
// 折叠状态
if (靠近边缘 && 鼠标离开) {
    折叠窗口到该边缘 // 90%隐藏
}

// 展开状态
if (靠近边缘 && 鼠标移到窗口) {
    展开窗口 // 完全显示
}

// 退出Mini模式
if (展开状态 && 单击窗口) {
    返回完整界面
}

// 折叠状态下的点击
if (折叠状态 && 单击) {
    仅展开，不退出
}
```

---

## 🪟 **自定义标题栏**

### **设计**

```
┌────────────────────────────────┐
│ FloatSort           ➖  ✕    │ ← 自定义标题栏（黑色）
├────────────────────────────────┤
│                                │
│        应用内容区域            │
│                                │
└────────────────────────────────┘
```

### **功能按钮**

| 按钮 | 图标 | 功能 | 快捷说明 |
|-----|------|-----|---------|
| **最小化** | `➖` | 进入Mini模式 | 缩小为悬浮窗 |
| **关闭** | `✕` | 退出应用 | 关闭FloatSort |

### **拖动功能**

- 整个标题栏区域支持拖动窗口
- 使用 `data-tauri-drag-region` 属性实现
- 无需额外代码，Tauri自动处理

### **配置变更**

**`src-tauri/tauri.conf.json`**:
```json
{
  "windows": [
    {
      "decorations": false,  // ✅ 关闭系统标题栏
      "alwaysOnTop": true
    }
  ]
}
```

---

## ⚙️ **批量确认阈值配置**

### **默认行为**

**V2.4及之前**：
- 超过 **5个文件** 才弹窗确认
- 用户无法修改

**V2.5**：
- 超过 **1个文件** 就弹窗确认（默认）
- 用户可自定义阈值

### **配置文件**

**位置**：`data/config.json`

**字段**：
```json
{
  "version": 2,
  "batch_threshold": 1,  // ← 批量确认阈值
  "folders": [...],
  "rules": [...]
}
```

### **阈值说明**

| 阈值 | 行为 | 适用场景 |
|-----|------|---------|
| **0** | 禁用批量确认，直接整理 | 完全信任规则，快速整理 |
| **1** | 任何文件都弹窗确认 | 精确控制，逐个确认 |
| **3** | 3个或以上弹窗 | 少量文件直接处理 |
| **5** | 5个或以上弹窗（旧默认） | 批量处理时确认 |
| **10+** | 大量文件才确认 | 高度自动化 |

### **修改方法**

#### **方法1：手动编辑配置文件**
```json
// data/config.json
{
  "batch_threshold": 3  // 改为3个文件才确认
}
```

#### **方法2：在应用中添加设置界面**（未来版本）
```
设置 → 批量整理 → 确认阈值: [3] 个文件
```

### **技术实现**

**后端 (`src-tauri/src/config.rs`)**:
```rust
pub struct AppConfig {
    #[serde(default = "default_batch_threshold")]
    pub batch_threshold: u32,  // 批量确认阈值
}

fn default_batch_threshold() -> u32 {
    1  // 默认为1
}
```

**前端 (`ui/app_v2.js`)**:
```javascript
// 从配置加载
async function loadConfig() {
    const config = await invoke('get_config');
    appState.batchThreshold = config.batch_threshold || 1;
}

// 使用阈值
if (pendingBatch.length >= appState.batchThreshold) {
    showBatchConfirm();  // 弹窗确认
} else {
    processDraggedFiles(files);  // 直接处理
}
```

---

## 🎯 **完整使用流程**

### **流程1：Mini模式 + 自动折叠**

```
1. 启动FloatSort
2. 点击自定义标题栏的 ➖ 按钮（或原有的minimizeBtn）
3. 进入Mini模式（300×300黑色窗口）
4. 拖动窗口到屏幕左边缘
5. 鼠标离开 → 窗口自动折叠，只露出一条边
6. 工作时拖拽文件到屏幕左边缘
7. 窗口自动展开 → 显示当前规则
8. 松手放入文件 → 自动整理
9. 鼠标离开 → 再次折叠
10. 需要设置时，鼠标移到边缘展开，点击 → 返回完整界面
```

### **流程2：批量确认（阈值=1）**

```
1. 拖拽 1个文件 到窗口
2. 立即弹出批量确认窗口
3. 显示：
   - 文件名
   - 原始路径
   - 目标路径（根据规则预览）
   - 匹配的规则名称
4. 点击"确认整理" → 移动文件
5. 点击"取消" → 不移动
```

### **流程3：自定义阈值**

```
1. 打开 data/config.json
2. 找到 "batch_threshold": 1
3. 修改为 "batch_threshold": 0  // 禁用批量确认
4. 保存文件
5. 重启FloatSort
6. 现在拖拽任意数量文件都直接整理，不弹窗
```

---

## 🎨 **视觉效果**

### **自定义标题栏**
```
┌────────────────────────────────┐
│ FloatSort           ➖  ✕    │  ← 黑色背景，白色文字
├────────────────────────────────┤
│  📂 FloatSort                  │
│  ▶️ ➕➖                       │
├────────────────────────────────┤
│  📋 规则  📁 文件夹  📊 活动    │
└────────────────────────────────┘
```

### **Mini窗口折叠（左边缘）**

**展开状态**:
```
┌──────────┐
│          │
│    📂    │
│   [A]    │
│图片归类   │
│  滚轮切换 │
│          │
└──────────┘
```

**折叠状态**:
```
┤
┤ 📂
┤ [A]
┤
┤
```
*(只露出10%的右边)*

---

## 🔧 **技术细节**

### **窗口位置检测**

```javascript
// 获取窗口和屏幕信息
const position = await appWindow.outerPosition();  // 窗口坐标
const size = await appWindow.outerSize();          // 窗口尺寸
const screenWidth = window.screen.width;           // 屏幕宽度
const screenHeight = window.screen.height;         // 屏幕高度

// 判断边缘
const edgeThreshold = 50; // 像素
if (position.x <= edgeThreshold) {
    // 靠近左边缘
} else if (position.x + size.width >= screenWidth - edgeThreshold) {
    // 靠近右边缘
}
```

### **CSS折叠动画**

```css
.mini-window {
    transition: transform 0.3s ease, opacity 0.3s ease;
}

.mini-window.collapsed-left {
    transform: translateX(-90%);  /* 向左移动90% */
}

.mini-window.collapsed-right {
    transform: translateX(90%);   /* 向右移动90% */
}
```

### **配置迁移**

- 旧配置文件（无 `batch_threshold`）自动补充默认值
- `#[serde(default = "default_batch_threshold")]` 确保兼容性

---

## 🧪 **测试指南**

### **测试1：自定义标题栏**

- [ ] 标题栏显示为黑色
- [ ] 显示 "FloatSort" 标题
- [ ] 点击标题栏可以拖动窗口
- [ ] 点击 ➖ 按钮进入Mini模式
- [ ] 点击 ✕ 按钮关闭应用

### **测试2：Mini窗口折叠（左边缘）**

1. 进入Mini模式
2. 拖动窗口到屏幕左边缘（距离边缘<50px）
3. 鼠标离开窗口
4. **预期**：窗口向左滑动，只露出右侧10%
5. 鼠标移到左边缘
6. **预期**：窗口自动展开
7. 点击展开的窗口
8. **预期**：返回完整界面

### **测试3：Mini窗口折叠（其他边缘）**

重复测试2，但测试：
- [ ] 右边缘：向右折叠
- [ ] 上边缘：向上折叠
- [ ] 下边缘：向下折叠

### **测试4：批量确认阈值=1**

1. 确保 `data/config.json` 中 `batch_threshold: 1`
2. 拖拽 **1个** 文件到窗口
3. **预期**：立即弹出批量确认窗口
4. 查看文件信息和目标路径
5. 点击"确认整理"
6. **预期**：文件移动到目标位置

### **测试5：批量确认阈值=0（禁用）**

1. 修改 `data/config.json`：`batch_threshold: 0`
2. 重启应用
3. 拖拽任意数量文件
4. **预期**：不弹窗，直接整理

---

## 📊 **变更文件清单**

### **后端文件**
- ✅ `src-tauri/tauri.conf.json` - 关闭系统标题栏
- ✅ `src-tauri/src/config.rs` - 添加 `batch_threshold` 字段

### **前端文件**
- ✅ `ui/index_v2.html` - 添加自定义标题栏
- ✅ `ui/styles_minimal.css` - 标题栏样式 + 折叠动画
- ✅ `ui/app_v2.js` - 折叠逻辑 + 配置加载

---

## 🎉 **用户体验提升**

### **之前**
- 有系统标题栏，占用空间
- Mini窗口一直完全显示，遮挡内容
- 批量确认阈值固定为5，不够灵活

### **现在**
- 无边框窗口，更简洁现代
- Mini窗口自动折叠，只在需要时展开
- 批量确认阈值可配置，精确控制

### **效果对比**

| 功能 | V2.4 | V2.5 | 改进 |
|-----|------|------|------|
| **标题栏** | Windows系统栏 | 自定义黑色栏 | 更简洁 |
| **Mini窗口** | 始终全显示 | 自动折叠隐藏 | 不遮挡 |
| **批量确认** | 固定5个 | 可配置（默认1） | 更灵活 |
| **窗口高度** | 520px | 552px | +32px标题栏 |

---

## 🔮 **未来增强**

### **计划功能**

1. **UI设置界面**
   - 直接在应用中调整批量阈值
   - 无需手动编辑JSON

2. **折叠行为配置**
   - 自定义边缘阈值（默认50px）
   - 自定义折叠比例（默认90%）
   - 禁用自动折叠选项

3. **多显示器支持**
   - 检测主显示器和副显示器边缘
   - 支持跨显示器拖动

4. **记忆功能**
   - 记住Mini窗口位置
   - 记住折叠状态偏好

---

## 📝 **配置文件示例**

**完整 `data/config.json` 示例**：

```json
{
  "version": 2,
  "batch_threshold": 1,
  "show_notifications": true,
  "log_level": "info",
  "folders": [
    {
      "id": "folder_1",
      "path": "C:\\Users\\YourName\\Desktop\\整理文件测试",
      "name": "测试文件夹",
      "enabled": true,
      "rule_ids": ["rule_images", "rule_documents"]
    }
  ],
  "rules": [
    {
      "id": "rule_images",
      "name": "图片文件归类",
      "enabled": true,
      "conditions": [
        {
          "type": "Extension",
          "values": ["jpg", "png", "gif"]
        }
      ],
      "action": {
        "type": "MoveTo",
        "destination": "Pictures"
      },
      "priority": 1
    }
  ]
}
```

---

**现在立即体验全新的V2.5功能！** 🚀

无边框窗口 + 自动折叠 + 可配置阈值 = 极致文件整理体验

