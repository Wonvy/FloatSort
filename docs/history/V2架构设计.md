# FloatSort V2 架构重构设计

## 📋 用户需求

1. **规则可以编辑修改** - 目前只能添加/删除，需要支持编辑
2. **文件夹独立管理** - 每个文件夹独立配置规则和监控开关
3. **UI 重构** - Tab 式布局：文件夹列表 + 规则列表

---

## 🎯 新架构设计

### **数据模型变更**

#### **当前架构（V1）**
```
AppConfig
├── watch_paths: Vec<String>  // 全局监控路径
├── rules: Vec<Rule>           // 全局规则
└── auto_start: bool           // 全局开关
```

**问题：**
- ❌ 所有文件夹共享同一套规则
- ❌ 无法单独控制某个文件夹的监控
- ❌ 规则无法编辑，只能删除重建

---

#### **新架构（V2）**
```
AppConfig
├── folders: Vec<WatchFolder>  // 文件夹列表
├── rules: Vec<Rule>           // 规则库（全局）
└── settings: GlobalSettings   // 全局设置

WatchFolder
├── id: String                // 文件夹 ID
├── name: String              // 显示名称
├── path: String              // 文件夹路径
├── enabled: bool             // 监控开关（独立）
└── rule_ids: Vec<String>     // 引用的规则ID列表
```

**优势：**
- ✅ 每个文件夹独立配置
- ✅ 每个文件夹独立开关
- ✅ 规则作为全局库，可复用
- ✅ 支持规则编辑

---

### **UI 架构变更**

#### **当前 UI（V1）**
```
┌─────────────────────────────┐
│  FloatSort - 智能文件整理   │
├─────────────────────────────┤
│  📂 拖拽区域                │
│                              │
│  统计信息                    │
│  ➕ 添加规则                │
│  👁️ 开始监控 (全局)        │
│  ⚙️ 设置                    │
│                              │
│  最近活动                    │
└─────────────────────────────┘
```

---

#### **新 UI（V2）**
```
┌─────────────────────────────┐
│  FloatSort - 智能文件整理   │
├─────────────────────────────┤
│  [📁 文件夹] [📋 规则]      │  ← Tab 切换
├─────────────────────────────┤
│                              │
│  【文件夹 Tab】             │
│  ┌────────────────────────┐ │
│  │ 下载文件夹    ✓ 监控中 │ │
│  │ C:\Downloads            │ │
│  │ 规则: 3 个              │ │
│  │ [编辑] [删除] [切换]  │ │
│  └────────────────────────┘ │
│                              │
│  ┌────────────────────────┐ │
│  │ 桌面清理      ✗ 已停止│ │
│  │ C:\Desktop              │ │
│  │ 规则: 2 个              │ │
│  │ [编辑] [删除] [切换]  │ │
│  └────────────────────────┘ │
│                              │
│  [➕ 添加文件夹]            │
│                              │
├─────────────────────────────┤
│                              │
│  【规则 Tab】               │
│  ┌────────────────────────┐ │
│  │ 图片归类     ✓ 启用    │ │
│  │ jpg, png, gif           │ │
│  │ → Pictures/             │ │
│  │ [编辑] [删除]          │ │
│  └────────────────────────┘ │
│                              │
│  ┌────────────────────────┐ │
│  │ 文档归类     ✓ 启用    │ │
│  │ pdf, doc, txt           │ │
│  │ → Documents/            │ │
│  │ [编辑] [删除]          │ │
│  └────────────────────────┘ │
│                              │
│  [➕ 添加规则]              │
│                              │
└─────────────────────────────┘
```

---

## 📂 实现步骤

### **Phase 1: 规则编辑功能** ⭐ 优先级高

#### 需要修改的文件：
1. `src-tauri/src/main.rs` - 添加 `update_rule` 命令
2. `ui/app.js` - 添加编辑规则逻辑
3. `ui/index.html` - 规则表单支持编辑模式
4. `ui/styles.css` - 编辑按钮样式

#### 工作量：**小** (1-2 小时)

---

### **Phase 2: 数据模型重构** ⭐ 优先级高

#### 需要修改的文件：
1. **`src-tauri/src/config.rs`** ✅ 已开始
   - 添加 `WatchFolder` 结构
   - 修改 `AppConfig` 结构
   
2. **`src-tauri/src/main.rs`**
   - 修改所有使用 `watch_paths` 的地方 → `folders`
   - 添加文件夹管理命令：
     - `add_folder`
     - `remove_folder`
     - `update_folder`
     - `toggle_folder`
   
3. **`src-tauri/src/file_monitor.rs`**
   - 修改监控逻辑，支持多文件夹独立监控
   - 每个文件夹使用自己的规则列表
   
4. **配置文件迁移**
   - 提供从 V1 到 V2 的配置迁移函数

#### 工作量：**中** (3-4 小时)

---

### **Phase 3: UI 完全重构** ⭐ 优先级中

#### 需要修改的文件：
1. **`ui/index.html`**
   - 移除原有单页布局
   - 添加 Tab 切换结构
   - 文件夹列表视图
   - 规则列表视图（已有）
   
2. **`ui/app.js`**
   - 重写事件监听器
   - 添加 Tab 切换逻辑
   - 添加文件夹管理函数
   - 修改规则管理函数
   
3. **`ui/styles.css`**
   - Tab 样式
   - 文件夹卡片样式
   - 规则卡片样式
   - 响应式布局

#### 工作量：**大** (4-5 小时)

---

### **Phase 4: 监控逻辑优化** ⭐ 优先级低

#### 功能：
1. 多文件夹同时监控
2. 每个文件夹独立应用规则
3. 监控状态管理

#### 工作量：**中** (2-3 小时)

---

## 🚀 推荐实施方案

### **方案 A：分步实现（推荐）**

1. **第一步：规则编辑** (立即实现)
   - ✅ 用户立即可用
   - ✅ 改动最小
   - ✅ 不影响现有功能
   
2. **第二步：数据模型 + 后端**
   - 重构后端逻辑
   - 保持前端兼容
   
3. **第三步：UI 重构**
   - 完全重做界面
   - 新旧数据模型同时支持

4. **第四步：测试和优化**
   - 完整测试
   - 性能优化

**总工作量：10-14 小时**

---

### **方案 B：一次性重构（高风险）**

直接实现所有功能，但风险较大：
- ❌ 改动面太广
- ❌ 容易出bug
- ❌ 难以回滚

**不推荐**

---

## 💡 立即可以做的：规则编辑功能

最快最简单的改进，我现在就可以实现：

### 后端改动
```rust
// src-tauri/src/main.rs
#[tauri::command]
fn update_rule(
    rule_id: String,
    rule: Rule,
    state: State<AppState>
) -> Result<(), String> {
    let mut config = state.config.lock().unwrap();
    
    if let Some(index) = config.rules.iter().position(|r| r.id == rule_id) {
        config.rules[index] = rule;
        config.save_to_file("data/config.json")?;
        Ok(())
    } else {
        Err("规则不存在".to_string())
    }
}
```

### 前端改动
```javascript
// 编辑规则
function editRule(ruleId) {
    // 打开模态框
    // 填充表单
    // 提交时调用 update_rule 而不是 add_rule
}
```

---

## 📊 决策建议

### 建议 1：先实现规则编辑 ✅
- 立即可用
- 改动最小
- 满足基本需求

### 建议 2：分阶段重构
- 第一阶段：规则编辑（本次）
- 第二阶段：数据模型重构（下次）
- 第三阶段：UI 重构（最后）

### 建议 3：保持向后兼容
- 支持旧配置文件自动迁移
- 提供配置文件版本号
- 升级时保留用户数据

---

## ❓ 需要确认

1. **是否立即实现规则编辑功能？** (快速，影响小)
2. **是否要完整重构？** (耗时，但架构更好)
3. **是否分阶段实施？** (推荐)

**请告诉我您的选择，我会据此继续实现！** 🚀

