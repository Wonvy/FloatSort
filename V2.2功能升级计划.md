# FloatSort V2.2 功能升级计划 🚀

**日期**: 2025-10-28  
**版本**: V2.1 → V2.2  
**目标**: 高级规则 + 批量确认 + 详细日志

---

## 📋 需求分析

### **需求 1: 规则支持高级条件** 🎯
**现状**: 后端已完全支持，前端UI未支持  
**目标**: 前端规则创建界面支持所有条件类型

**已支持的条件类型:**
- ✅ `Extension` - 文件扩展名
- ✅ `SizeRange` - 文件大小范围
- ✅ `NameContains` - 文件名包含
- ✅ `NameRegex` - 正则表达式匹配
- ✅ `CreatedDaysAgo` - 创建时间（天数）
- ✅ `ModifiedDaysAgo` - 修改时间（天数）

**需要做的:**
- 更新前端规则表单
- 添加高级选项折叠面板
- 添加多条件支持

---

### **需求 2: 批量整理确认** ⚠️
**现状**: 文件监控后立即整理  
**目标**: 超过5个文件时弹出确认窗口

**实现方案:**

#### **方案 A: 前端收集 + 弹窗确认** ⭐（推荐）
```javascript
// 前端维护待整理队列
pendingFiles = []

// 监听文件检测事件
on('file-detected') {
    pendingFiles.push(file)
    
    if (pendingFiles.length >= 5) {
        showBatchConfirmDialog(pendingFiles)
    }
}

// 确认后批量整理
async function confirmAndOrganize(files) {
    for (file of files) {
        await invoke('process_file', { path: file })
    }
}
```

**优点:**
- 实现简单
- 不影响监控逻辑
- 用户体验好

**缺点:**
- 监控和手动整理行为不一致

#### **方案 B: 后端缓存 + 批量处理**
```rust
// 后端维护待整理队列
struct PendingBatch {
    files: Vec<PathBuf>,
    timer: Option<Instant>,
}

// 收集文件，3秒内超过5个触发批量
```

**优点:**
- 监控和手动整理行为一致
- 更智能的批量检测

**缺点:**
- 实现复杂
- 需要定时器逻辑

**决定**: 使用方案 A

---

### **需求 3: 详细活动日志** 📊
**现状**: 只显示文件名  
**目标**: 显示整理前后完整路径

**修改点:**
1. 后端事件增加 `original_path` 和 `new_path`
2. 前端日志显示格式调整

---

## 🛠️ 实现步骤

### **Step 1: 前端规则表单升级** ⏱️ 1小时

#### 1.1 HTML 结构
```html
<div class="form-group">
    <label>条件类型</label>
    <select id="ruleType">
        <option value="extension">文件扩展名</option>
        <option value="name">文件名包含</option>
        <option value="regex">正则表达式</option>
        <option value="size">文件大小</option>
        <option value="created">创建时间</option>
        <option value="modified">修改时间</option>
    </select>
</div>

<div class="form-group" id="conditionValue">
    <!-- 根据类型动态显示不同输入 -->
</div>

<div class="form-group">
    <button type="button" id="addCondition">➕ 添加条件</button>
    <div id="conditionsList"></div>
</div>
```

#### 1.2 动态表单逻辑
```javascript
// 根据类型显示不同输入
function updateConditionInput(type) {
    switch(type) {
        case 'size':
            return `
                <input type="number" placeholder="最小 (MB)">
                <input type="number" placeholder="最大 (MB)">
            `;
        case 'created':
        case 'modified':
            return `
                <input type="number" placeholder="最少天数前">
                <input type="number" placeholder="最多天数前">
            `;
        // ...
    }
}
```

---

### **Step 2: 批量确认窗口** ⏱️ 1.5小时

#### 2.1 HTML 结构
```html
<div class="modal" id="batchConfirmModal">
    <div class="modal-content large">
        <div class="modal-header">
            <h2>🔔 批量整理确认</h2>
            <p>检测到 <span id="batchCount">5</span> 个文件待整理</p>
        </div>
        <div class="modal-body">
            <div class="batch-file-list" id="batchFileList">
                <!-- 文件列表 -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" id="cancelBatch">取消</button>
            <button class="btn-primary" id="confirmBatch">确认整理</button>
        </div>
    </div>
</div>
```

#### 2.2 文件列表项
```html
<div class="batch-file-item">
    <div class="file-icon">📄</div>
    <div class="file-info">
        <div class="file-name">document.pdf</div>
        <div class="file-path from">
            <span class="label">从:</span>
            C:\Users\...\Desktop\document.pdf
        </div>
        <div class="file-path to">
            <span class="label">到:</span>
            C:\Users\...\Desktop\Documents\document.pdf
        </div>
    </div>
</div>
```

#### 2.3 批量处理逻辑
```javascript
let pendingBatch = [];

// 监听文件检测
listen('file-detected', (event) => {
    pendingBatch.push({
        originalPath: event.payload.file_path,
        // 预测目标路径
        targetPath: await predictTarget(event.payload.file_path)
    });
    
    if (pendingBatch.length >= 5) {
        showBatchConfirm(pendingBatch);
        pendingBatch = [];
    }
});

// 显示确认窗口
function showBatchConfirm(files) {
    document.getElementById('batchCount').textContent = files.length;
    // 渲染文件列表
    renderBatchList(files);
    // 显示模态框
    batchConfirmModal.style.display = 'flex';
}

// 确认整理
async function confirmBatch() {
    for (const file of currentBatch) {
        await invoke('process_file', { path: file.originalPath });
    }
    closeBatchModal();
}
```

---

### **Step 3: 详细活动日志** ⏱️ 30分钟

#### 3.1 后端事件已包含路径
查看现有事件：
```rust
window.emit("file-organized", {
    "original_path": file_info.path,
    "new_path": new_path.clone(),
    "file_name": file_info.name.clone(),
})
```
✅ 后端已经发送了完整信息！

#### 3.2 前端日志显示
```javascript
listen('file-organized', (event) => {
    const { original_path, new_path, file_name } = event.payload;
    
    addActivity(`
        ✅ <strong>${file_name}</strong><br>
        <span class="path-from">从: ${original_path}</span><br>
        <span class="path-to">到: ${new_path}</span>
    `);
});
```

---

## 📐 UI 设计

### **规则表单 - 高级模式**
```
┌────────────────────────────────────┐
│ 📝 创建规则                         │
├────────────────────────────────────┤
│ 规则名称: [_____________]           │
│                                    │
│ 条件1: [扩展名 ▼] [jpg, png]  [×]  │
│ 条件2: [大小 ▼] [最小: 10MB]  [×]  │
│        添加条件 ➕                  │
│                                    │
│ 动作: [移动到 ▼] [Pictures]        │
│                                    │
│ [取消] [保存]                       │
└────────────────────────────────────┘
```

### **批量确认窗口**
```
┌────────────────────────────────────┐
│ 🔔 批量整理确认                     │
│ 检测到 5 个文件待整理                │
├────────────────────────────────────┤
│ ┌───────────────────────────────┐  │
│ │ 📄 document.pdf               │  │
│ │ 从: C:\...\Desktop\doc.pdf    │  │
│ │ 到: C:\...\Documents\doc.pdf  │  │
│ └───────────────────────────────┘  │
│ ┌───────────────────────────────┐  │
│ │ 📄 image.jpg                  │  │
│ │ 从: C:\...\Desktop\img.jpg    │  │
│ │ 到: C:\...\Pictures\img.jpg   │  │
│ └───────────────────────────────┘  │
│ ...                                │
├────────────────────────────────────┤
│ [取消] [确认整理]                   │
└────────────────────────────────────┘
```

### **活动日志 - 详细模式**
```
┌────────────────────────────────────┐
│ 📊 活动日志                         │
├────────────────────────────────────┤
│ 17:45 ✅ document.pdf              │
│       从: C:\Users\...\Desktop\... │
│       到: C:\Users\...\Documents\..│
│                                    │
│ 17:44 📥 image.jpg (检测)          │
│                                    │
│ 17:43 ⚠️ video.mp4 (未匹配)       │
└────────────────────────────────────┘
```

---

## 🎨 样式设计

### **批量确认窗口样式**
```css
.batch-file-list {
    max-height: 400px;
    overflow-y: auto;
}

.batch-file-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 10px;
}

.file-path.from {
    color: #e74c3c;
}

.file-path.to {
    color: #27ae60;
}

.path-label {
    font-weight: 500;
    margin-right: 8px;
}
```

### **活动日志样式**
```css
.activity-item .path-from,
.activity-item .path-to {
    font-size: 11px;
    color: #999;
    padding-left: 20px;
}

.activity-item .path-from::before {
    content: "📤 ";
}

.activity-item .path-to::before {
    content: "📥 ";
}
```

---

## 🧪 测试计划

### **规则条件测试**
1. 创建正则表达式规则
2. 创建大小范围规则
3. 创建日期范围规则
4. 多条件组合测试

### **批量确认测试**
1. 快速添加5个文件，触发确认窗口
2. 确认整理，验证所有文件正确移动
3. 取消整理，验证文件不移动
4. 添加4个文件，不触发确认（自动整理）

### **活动日志测试**
1. 整理文件，查看详细路径
2. 长路径是否正确显示
3. 多个文件快速整理

---

## 📊 开发时间估算

| 任务 | 预计时间 |
|------|---------|
| 规则表单升级 | 1.0 小时 |
| 批量确认窗口 | 1.5 小时 |
| 详细活动日志 | 0.5 小时 |
| 测试和调试 | 1.0 小时 |
| **总计** | **4.0 小时** |

---

## ✅ 实现优先级

### **P0 - 立即实现**
1. ✅ 详细活动日志（最简单，已有数据）
2. ✅ 批量确认窗口（核心功能）

### **P1 - 下一步**
3. ⏳ 规则表单升级（工作量大，独立功能）

---

**准备好开始实现了吗？** 🚀

